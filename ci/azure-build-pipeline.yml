pool:

  name: Hosted Ubuntu 1604

#Your build pipeline references an undefined variable named ‘mavenCredentials.secureFilePath’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972

#Your build pipeline references an undefined variable named ‘git describe’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972



steps:

- task: AzureResourceGroupDeployment@2

  displayName: 'Azure Deployment:Create Azure Container Registry'

  inputs:

    azureSubscription: 'supercluster-dna - Azure'

    resourceGroupName: 'search_resources'

    location: eastus

    templateLocation: 'URL of the file'

    csmFileLink: 'https://raw.githubusercontent.com/Microsoft/devops-project-samples/057f6cc268a62922d012067d069d58684e967d0a/armtemplates/webapp-containers/containerRegistry-template.json'

    overrideParameters: '-registryName "supercluster" -registryLocation "East US" -registrySku "Standard"'

  enabled: false



- task: DownloadSecureFile@1

  displayName: 'Retrieve Maven Credentials'

  inputs:

    secureFile: '91c4c16b-4018-42e6-80e2-8953579185e8'



- powershell: |
   New-Item -Type Directory -Force "/Users/fizz/.m2"
   Copy-Item -Force "$(mavenCredentials.secureFilePath)" "/Users/fizz/.m2/settings.xml"

  displayName: 'Setup Maven Repo Access'



- script: 'echo "##vso[task.setvariable variable=appVersion;isSecret=false;isOutput=true;]$(git describe)"'

  displayName: 'Set App Version'

  name: 'az'



- script: 'ci/build-docker-image supercluster.azurecr.io/ga4gh-search-adapter-presto:$(az.appVersion) ga4gh-search-adapter-presto $(az.appVersion)'

  displayName: 'Build Image: ga4gh-search-adapter-presto'



- task: Docker@1

  displayName: 'Push an image: ga4gh-search-adapter-presto'

  inputs:

    azureSubscriptionEndpoint: 'supercluster-dna - Azure'

    azureContainerRegistry: supercluster.azurecr.io

    command: 'Push an image'

    imageName: 'ga4gh-search-adapter-presto:$(az.appVersion)'

    includeSourceTags: true



- script: 'ci/build-docker-e2e-image supercluster.azurecr.io/ga4gh-search-adapter-presto-e2e-tests:$(az.appVersion) ga4gh-search-adapter-presto $(az.appVersion)'

  displayName: 'Build E2E Docker Image'



- task: Docker@1

  displayName: 'Push an image: ga4gh-search-adapter-presto-e2e-tests'

  inputs:

    azureSubscriptionEndpoint: 'supercluster-dna - Azure'

    azureContainerRegistry: supercluster.azurecr.io

    command: 'Push an image'

    imageName: 'ga4gh-search-adapter-presto-e2e-tests:$(az.appVersion)'

    includeSourceTags: true



